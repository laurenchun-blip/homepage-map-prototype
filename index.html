<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Discover Locations – Map Section</title>

    <link
      href="https://unpkg.com/maplibre-gl@3.6.0/dist/maplibre-gl.css"
      rel="stylesheet"
    />
    <script src="https://unpkg.com/maplibre-gl@3.6.0/dist/maplibre-gl.js"></script>

    <style>
      :root {
        --pink: #ff3e86;
        --light-pink: #fca5d3;
        --cta: #3056d3;
        --ink: #1b1c20;
        --muted: #5f6a7a;
        --bg: #f7f9fc;
      }

      body {
        margin: 0;
        font-family: "Inter", system-ui, sans-serif;
        color: var(--ink);
        background-color: var(--bg);
      }

      section.map-section {
        padding: 60px 24px;
        text-align: center;
        max-width: 1200px;
        margin: 0 auto;
      }

      section.map-section h2 {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 8px;
        color: var(--ink);
      }

      section.map-section p {
        color: var(--muted);
        max-width: 700px;
        margin: 0 auto 28px;
        font-size: 1rem;
        line-height: 1.5;
      }

      .map-container {
        position: relative;
        height: 560px;
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      #map {
        height: 100%;
        width: 100%;
        border-radius: 16px;
      }

      .search-box {
        position: absolute;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 2;
        background: #fff;
        border-radius: 10px;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.25);
        display: flex;
        gap: 8px;
        padding: 8px 10px;
        align-items: center;
      }

      .search-box input {
        border: none;
        outline: none;
        font-size: 14px;
        width: 250px;
      }

      .search-box button {
        background: var(--cta);
        color: #fff;
        border: none;
        padding: 8px 14px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
      }

      .popup {
        font-size: 14px;
        text-align: center;
      }
      .popup img {
        width: 200px;
        height: 100px;
        object-fit: cover;
        border-radius: 6px;
        margin-bottom: 6px;
      }
      .popup .cta {
        display: inline-block;
        background: var(--cta);
        color: #fff;
        text-decoration: none;
        padding: 5px 10px;
        border-radius: 4px;
        margin-top: 4px;
      }
    </style>
  </head>
  <body>
    <section class="map-section">
      <h2>Discover Locations To Reach Your Next Customer</h2>
      <p>
        Appear locally or nationwide. Select screens in your desired markets
        with your target audience.
      </p>

      <div class="map-container">
        <div class="search-box">
          <input
            id="search"
            type="text"
            placeholder="Enter a city (e.g. New York, Chicago)"
          />
          <button onclick="searchCity()">Search</button>
        </div>
        <div id="map"></div>
      </div>
    </section>

    <script src="signs-data.js"></script>
    <script>
      // Convert SIGN_DATA to GeoJSON
      const geojson = {
        type: "FeatureCollection",
        features: SIGN_DATA.map((s) => ({
          type: "Feature",
          geometry: { type: "Point", coordinates: [s.coords[1], s.coords[0]] },
          properties: {
            city: s.city,
            venue: s.venue,
            img: s.img,
            href: s.href,
          },
        })),
      };

      // Initialize MapLibre map
      const map = new maplibregl.Map({
        container: "map",
        style: {
          version: 8,
          sources: {
            osm: {
              type: "raster",
              tiles: [
                "https://a.tile.openstreetmap.org/{z}/{x}/{y}.png",
                "https://b.tile.openstreetmap.org/{z}/{x}/{y}.png",
                "https://c.tile.openstreetmap.org/{z}/{x}/{y}.png",
              ],
              tileSize: 256,
              attribution: "&copy; OpenStreetMap contributors",
            },
          },
          layers: [{ id: "osm", type: "raster", source: "osm" }],
        },
        center: [-98.35, 39.5],
        zoom: 4,
      });

      map.addControl(new maplibregl.NavigationControl());

      map.on("load", () => {
        map.addSource("signs", {
          type: "geojson",
          data: geojson,
          cluster: true,
          clusterMaxZoom: 18,
          clusterRadius: 60,
        });

        // DMA-level clusters (≤ zoom 12)
        map.addLayer({
          id: "dma-clusters",
          type: "circle",
          source: "signs",
          filter: ["all", ["has", "point_count"], ["<=", ["zoom"], 12]],
          paint: {
            "circle-color": "#ff3e86",
            "circle-radius": [
              "step",
              ["get", "point_count"],
              20,
              10,
              30,
              50,
              40,
            ],
            "circle-opacity": 0.85,
          },
        });

        map.addLayer({
          id: "dma-count",
          type: "symbol",
          source: "signs",
          filter: ["all", ["has", "point_count"], ["<=", ["zoom"], 12]],
          layout: {
            "text-field": ["get", "point_count_abbreviated"],
            "text-size": 14,
            "text-font": ["Open Sans Bold", "Arial Unicode MS Bold"],
          },
          paint: { "text-color": "#fff" },
        });

        // Smaller clusters (> zoom 12)
        map.addLayer({
          id: "local-clusters",
          type: "circle",
          source: "signs",
          filter: ["all", ["has", "point_count"], [">", ["zoom"], 12]],
          paint: {
            "circle-color": "#fca5d3",
            "circle-radius": [
              "step",
              ["get", "point_count"],
              12,
              10,
              18,
              30,
              25,
            ],
            "circle-opacity": 0.85,
          },
        });

        map.addLayer({
          id: "local-count",
          type: "symbol",
          source: "signs",
          filter: ["all", ["has", "point_count"], [">", ["zoom"], 12]],
          layout: {
            "text-field": ["get", "point_count_abbreviated"],
            "text-size": 12,
            "text-font": ["Open Sans Bold", "Arial Unicode MS Bold"],
          },
          paint: { "text-color": "#fff" },
        });

        // Preview popup on DMA clusters
        map.on("click", "dma-clusters", (e) => {
          const cluster = map.queryRenderedFeatures(e.point, {
            layers: ["dma-clusters"],
          })[0];
          const clusterId = cluster.properties.cluster_id;
          const source = map.getSource("signs");

          source.getClusterLeaves(clusterId, 5, 0, (err, leaves) => {
            if (err || !leaves.length) return;
            const p =
              leaves[Math.floor(Math.random() * leaves.length)].properties;
            const coords = cluster.geometry.coordinates;

            new maplibregl.Popup({ offset: 20 })
              .setLngLat(coords)
              .setHTML(
                `
              <div class="popup">
                <img src="${p.img}" alt="${p.venue}">
                <strong>${p.city}</strong><br/>
                <a href="${p.href}" target="_blank" class="cta">Log in to get started</a>
              </div>
            `
              )
              .addTo(map);
          });
        });

        // Click on local clusters → zoom deeper
        map.on("click", "local-clusters", (e) => {
          const cluster = map.queryRenderedFeatures(e.point, {
            layers: ["local-clusters"],
          })[0];
          const clusterId = cluster.properties.cluster_id;
          map
            .getSource("signs")
            .getClusterExpansionZoom(clusterId, (err, zoom) => {
              if (err) return;
              map.easeTo({ center: cluster.geometry.coordinates, zoom });
            });
        });

        // Cursor styles
        ["dma-clusters", "local-clusters"].forEach((layer) => {
          map.on(
            "mouseenter",
            layer,
            () => (map.getCanvas().style.cursor = "pointer")
          );
          map.on(
            "mouseleave",
            layer,
            () => (map.getCanvas().style.cursor = "")
          );
        });
      });

      // Offline mock search
      const cityCenters = {
        "new york": [-74.006, 40.7128],
        chicago: [-87.6298, 41.8781],
        dallas: [-96.797, 32.7767],
        houston: [-95.3698, 29.7604],
        "los angeles": [-118.2437, 34.0522],
        miami: [-80.1918, 25.7617],
      };

      function searchCity() {
        const input = document
          .getElementById("search")
          .value.trim()
          .toLowerCase();
        const coords = cityCenters[input];
        if (coords) {
          map.flyTo({ center: coords, zoom: 9, speed: 0.7 });
        } else {
          alert(
            "City not found. Try New York, Chicago, Dallas, Houston, LA, Miami."
          );
        }
      }

      document.getElementById("search").addEventListener("keydown", (e) => {
        if (e.key === "Enter") searchCity();
      });
    </script>
  </body>
</html>
